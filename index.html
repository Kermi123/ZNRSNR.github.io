<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–ù–† –ü–†–û–¢–ò–í –°–ù–† map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        .leaflet-tile-container img.leaflet-tile-loaded {
            border: none;
        }
        .leaflet-draw-toolbar .leaflet-draw-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .leaflet-draw-toolbar .leaflet-draw-actions-bottom {
            margin-top: 5px;
        }
        .color-picker {
            width: 16px;
            height: 16px;
            margin: 4px auto 0;
            border-radius: 2px;
            cursor: pointer;
            background-color: #ff0000;
            position: relative;
            box-sizing: border-box;
            z-index: 999;
        }
        .color-picker input[type="color"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }
        .opacity-control {
            position: absolute;
            top: 60px;
            right: 10px;
            background: white;
            padding: 5px;
            border-radius: 3px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            z-index: 1000;
        }
        .opacity-slider {
            width: 100px;
            display: block;
        }
        .opacity-label {
            font-size: 12px;
            text-align: center;
            margin-bottom: 5px;
        }
        .selected-layer {
            weight: 5 !important;
        }
        .leaflet-draw-toolbar.marker-type-control {
            background: transparent;
            border: none;
            box-shadow: none;
        }
        .marker-type-button {
            width: 30px;
            height: 30px;
            font-size: 20px;
            line-height: 30px;
            text-align: center;
            border: none;
            cursor: pointer;
            background-color: #fff;
            margin: 1px 0;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            border-radius: 4px;
        }
        .marker-type-button.active {
            background-color: #f4f4f4;
        }
        .leaflet-marker-icon.emoji-marker {
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            line-height: 24px !important;
            text-align: center;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
        }
        .settings-popup .leaflet-popup-content {
            width: 200px;
            padding: 10px;
        }
        .settings-popup .leaflet-popup-content-wrapper {
            border-radius: 5px;
        }
        .settings-popup label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .settings-popup input[type="color"] {
            width: 100%;
            height: 30px;
            margin-bottom: 10px;
        }
        .settings-popup input[type="range"] {
            width: 100%;
            margin-bottom: 10px;
        }
        .settings-popup button {
            width: 100%;
            padding: 8px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .settings-popup button:hover {
            background-color: #45a049;
        }
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .login-form {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-in-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .login-form input {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .login-form input:focus {
            border-color: #4CAF50;
        }
        .login-form button {
            width: 100%;
            padding: 0.75rem;
            margin-top: 1rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-form button:hover {
            background: #45a049;
        }
        .login-form .toggle-link {
            color: #4CAF50;
            cursor: pointer;
            text-decoration: underline;
        }
        .logout-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            z-index: 1001;
        }
        .role-indicator {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: #4CAF50;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            z-index: 1001;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div id="loginModal" class="login-modal hidden">
        <div class="login-form">
            <h2 id="formTitle" class="text-2xl font-bold mb-4 text-gray-800">–í—Ö–æ–¥</h2>
            <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="text-gray-700">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" class="text-gray-700">
            <button id="authButton" class="mt-4">–í–æ–π—Ç–∏</button>
            <p class="mt-4 text-gray-600">
                <span id="toggleText">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? </span>
                <span id="toggleLink" class="toggle-link">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
            </p>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ–±—â–µ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        if (!localStorage.getItem('users')) {
            localStorage.setItem('users', JSON.stringify({}));
        }
        if (!sessionStorage.getItem('sharedDrawnLayers')) {
            sessionStorage.setItem('sharedDrawnLayers', JSON.stringify({ type: 'FeatureCollection', features: [] }));
        }
        if (!sessionStorage.getItem('adminStatus')) {
            sessionStorage.setItem('adminStatus', JSON.stringify({ isTaken: false, adminUsername: null }));
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        function registerUser(username, password) {
            const users = JSON.parse(localStorage.getItem('users'));
            if (users[username]) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                return false;
            }
            const adminStatus = JSON.parse(sessionStorage.getItem('adminStatus'));
            const role = username.toLowerCase() === 'admin' && !adminStatus.isTaken ? 'admin' : 'user';
            if (username.toLowerCase() === 'admin' && adminStatus.isTaken) {
                alert('–†–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞!');
                return false;
            }
            users[username] = { password, role };
            localStorage.setItem('users', JSON.stringify(users));
            if (role === 'admin') {
                sessionStorage.setItem('adminStatus', JSON.stringify({ isTaken: true, adminUsername: username }));
            }
            console.log(`–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${username}, —Ä–æ–ª—å: ${role}`);
            return true;
        }

        function loginUser(username, password) {
            const users = JSON.parse(localStorage.getItem('users'));
            if (users[username] && users[username].password === password) {
                const adminStatus = JSON.parse(sessionStorage.getItem('adminStatus'));
                const role = username.toLowerCase() === 'admin' && !adminStatus.isTaken ? 'admin' : 'user';
                if (username.toLowerCase() === 'admin' && adminStatus.isTaken && adminStatus.adminUsername !== username) {
                    alert('–†–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞!');
                    return false;
                }
                localStorage.setItem('currentUser', username);
                localStorage.setItem('userRole', role);
                if (role === 'admin') {
                    sessionStorage.setItem('adminStatus', JSON.stringify({ isTaken: true, adminUsername: username }));
                }
                console.log(`–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: ${username}, —Ä–æ–ª—å: ${role}`);
                return true;
            }
            alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å!');
            console.log(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${username}`);
            return false;
        }

        function logout() {
            const username = localStorage.getItem('currentUser');
            const role = localStorage.getItem('userRole');
            if (role === 'admin') {
                sessionStorage.setItem('adminStatus', JSON.stringify({ isTaken: false, adminUsername: null }));
            }
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userRole');
            location.reload();
        }

        function isAdmin() {
            const role = localStorage.getItem('userRole');
            console.log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏: ${role}`);
            return role === 'admin';
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º–æ–π
        const loginModal = document.getElementById('loginModal');
        const formTitle = document.getElementById('formTitle');
        const authButton = document.getElementById('authButton');
        const toggleLink = document.getElementById('toggleLink');
        const toggleText = document.getElementById('toggleText');
        let isLoginMode = true;

        function toggleFormMode() {
            isLoginMode = !isLoginMode;
            formTitle.textContent = isLoginMode ? '–í—Ö–æ–¥' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
            authButton.textContent = isLoginMode ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            toggleText.textContent = isLoginMode ? '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? ' : '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? ';
            toggleLink.textContent = isLoginMode ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' : '–í–æ–π—Ç–∏';
        }

        toggleLink.addEventListener('click', toggleFormMode);

        authButton.addEventListener('click', () => {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å!');
                return;
            }
            if (isLoginMode) {
                if (loginUser(username, password)) {
                    loginModal.classList.add('hidden');
                    initMap();
                }
            } else {
                if (registerUser(username, password)) {
                    if (loginUser(username, password)) {
                        loginModal.classList.add('hidden');
                        initMap();
                    }
                }
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            const role = localStorage.getItem('userRole') || 'user';
            const username = localStorage.getItem('currentUser') || '–ì–æ—Å—Ç—å';
            console.log(`–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –¥–ª—è: ${username}, —Ä–æ–ª—å: ${role}`);

            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–æ–ª–∏ –≤ –ª–µ–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É
            const roleIndicator = document.createElement('div');
            roleIndicator.className = 'role-indicator';
            roleIndicator.innerHTML = `<strong>${username}</strong> (${role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'})`;
            document.body.appendChild(roleIndicator);

            // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
            const logoutBtn = document.createElement('button');
            logoutBtn.className = 'logout-btn';
            logoutBtn.textContent = '–í—ã–π—Ç–∏';
            logoutBtn.onclick = logout;
            document.body.appendChild(logoutBtn);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
            var southWest = L.latLng(44.0, 22.0);
            var northEast = L.latLng(53.0, 40.5);
            var bounds = L.latLngBounds(southWest, northEast);

            var map = L.map('map', {
                center: [48.3794, 31.1656],
                zoom: 6,
                minZoom: 5,
                maxZoom: 18,
                maxBounds: bounds,
                maxBoundsViscosity: 1.0,
                zoomAnimation: true,
                zoomSnap: 1,
                preferCanvas: true,
                trackResize: true,
                noWrap: true
            });

            map.fitBounds(bounds);

            var tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://carto.com/attributions">CartoDB</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                subdomains: 'abcd',
                maxZoom: 20,
                minZoom: 0,
                updateWhenIdle: true,
                keepBuffer: 3,
                detectRetina: true,
                errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
                noWrap: true
            }).addTo(map);

            map.on('tileloadstart', function(e) { console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–π–ª–∞:', e.coords); });
            map.on('tileload', function(e) { console.log('–¢–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω:', e.coords); });
            map.on('tileerror', function(e) { console.error('–û—à–∏–±–∫–∞ —Ç–∞–π–ª–∞:', e.coords, e.tile); });

            var drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            var currentColor = '#ff0000';
            var currentOpacity = 0.5;
            var currentMarkerType = 'rocket';

            const markerIcons = {
                rocket: L.divIcon({
                    html: 'üöÄ',
                    className: 'emoji-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 24],
                    popupAnchor: [0, -24]
                }),
                airfield: L.divIcon({
                    html: '‚úàÔ∏è',
                    className: 'emoji-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 24],
                    popupAnchor: [0, -24]
                }),
                base: L.divIcon({
                    html: '‚öîÔ∏è',
                    className: 'emoji-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 24],
                    popupAnchor: [0, -24]
                })
            };

            // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞
            if (isAdmin()) {
                var drawControl = new L.Control.Draw({
                    position: 'topleft',
                    draw: {
                        polyline: {
                            shapeOptions: {
                                color: currentColor,
                                weight: 3
                            }
                        },
                        polygon: {
                            shapeOptions: {
                                color: currentColor,
                                fillColor: currentColor,
                                fillOpacity: currentOpacity
                            }
                        },
                        rectangle: false,
                        circle: false,
                        marker: false,
                        circlemarker: false
                    },
                    edit: {
                        featureGroup: drawnItems
                    }
                });
                map.addControl(drawControl);

                var MarkerTypeControl = L.Control.extend({
                    options: {
                        position: 'topleft'
                    },
                    onAdd: function(map) {
                        var container = L.DomUtil.create('div', 'leaflet-draw-toolbar marker-type-control leaflet-bar');
                        var types = [
                            { name: '–†–∞–∫–µ—Ç–∞', type: 'rocket', emoji: 'üöÄ' },
                            { name: '–ê—ç—Ä–æ–¥—Ä–æ–º', type: 'airfield', emoji: '‚úàÔ∏è' },
                            { name: '–í–æ–µ–Ω–Ω–∞—è –±–∞–∑–∞', type: 'base', emoji: '‚öîÔ∏è' }
                        ];

                        types.forEach(function(typeObj) {
                            var button = L.DomUtil.create('a', 'marker-type-button', container);
                            button.title = typeObj.name;
                            button.innerHTML = typeObj.emoji;
                            if (typeObj.type === currentMarkerType) {
                                button.classList.add('active');
                            }
                            L.DomEvent.on(button, 'click', function(e) {
                                L.DomEvent.stopPropagation(e);
                                container.querySelectorAll('.marker-type-button').forEach(btn => btn.classList.remove('active'));
                                button.classList.add('active');
                                currentMarkerType = typeObj.type;
                                new L.Draw.Marker(map, {
                                    icon: markerIcons[typeObj.type]
                                }).enable();
                            });
                        });

                        return container;
                    }
                });

                map.addControl(new MarkerTypeControl());

                function addColorPicker() {
                    var actionsContainer = document.querySelector('.leaflet-draw-actions');
                    if (!actionsContainer || document.querySelector('.color-picker')) return;

                    var pickerContainer = document.createElement('div');
                    pickerContainer.className = 'color-picker';
                    var colorInput = document.createElement('input');
                    colorInput.type = 'color';
                    colorInput.value = currentColor;
                    colorInput.addEventListener('change', function(e) {
                        currentColor = e.target.value;
                        pickerContainer.style.backgroundColor = e.target.value;
                        drawControl.setDrawingOptions({
                            polyline: {
                                shapeOptions: {
                                    color: currentColor,
                                    weight: 3
                                }
                            },
                            polygon: {
                                shapeOptions: {
                                    color: currentColor,
                                    fillColor: currentColor,
                                    fillOpacity: currentOpacity
                                }
                            }
                        });
                    });
                    pickerContainer.appendChild(colorInput);
                    actionsContainer.parentNode.insertBefore(pickerContainer, actionsContainer.nextSibling);
                }

                function addOpacityControl() {
                    if (document.querySelector('.opacity-control')) return;

                    var opacityControl = document.createElement('div');
                    opacityControl.className = 'opacity-control';
                    var label = document.createElement('div');
                    label.className = 'opacity-label';
                    label.textContent = 'Opacity';
                    var opacityInput = document.createElement('input');
                    opacityInput.type = 'range';
                    opacityInput.className = 'opacity-slider';
                    opacityInput.min = '0';
                    opacityInput.max = '1';
                    opacityInput.step = '0.1';
                    opacityInput.value = currentOpacity;
                    opacityInput.addEventListener('input', function(e) {
                        currentOpacity = parseFloat(e.target.value);
                        drawControl.setDrawingOptions({
                            polygon: {
                                shapeOptions: {
                                    color: currentColor,
                                    fillColor: currentColor,
                                    fillOpacity: currentOpacity
                                }
                            }
                        });
                    });
                    opacityControl.appendChild(label);
                    opacityControl.appendChild(opacityInput);
                    document.getElementById('map').parentNode.appendChild(opacityControl);
                }

                setTimeout(function() {
                    addColorPicker();
                    addOpacityControl();
                }, 100);
                map.on('draw:drawstart', function() {
                    setTimeout(addColorPicker, 100);
                });
            }

            const MIN_ZOOM_FOR_MARKERS = 9;

            function updateMarkerVisibility() {
                const currentZoom = map.getZoom();
                drawnItems.eachLayer(function(layer) {
                    if (layer instanceof L.Marker) {
                        layer.setOpacity(currentZoom >= MIN_ZOOM_FOR_MARKERS ? 1 : 0);
                    }
                });
            }

            map.on('zoomend', updateMarkerVisibility);

            function saveLayers() {
                var geoJson = drawnItems.toGeoJSON();
                sessionStorage.setItem('sharedDrawnLayers', JSON.stringify(geoJson));
            }

            function loadLayers() {
                var savedLayers = sessionStorage.getItem('sharedDrawnLayers');
                if (savedLayers) {
                    var geoJson = JSON.parse(savedLayers);
                    L.geoJSON(geoJson, {
                        style: function(feature) {
                            return {
                                color: feature.properties.color || currentColor,
                                fillColor: feature.properties.fillColor || currentColor,
                                fillOpacity: feature.properties.fillOpacity !== undefined ? feature.properties.fillOpacity : currentOpacity,
                                weight: feature.properties.weight || 3
                            };
                        },
                        pointToLayer: function(feature, latlng) {
                            if (feature.geometry.type === 'Point') {
                                var markerType = feature.properties.markerType || 'rocket';
                                var marker = L.marker(latlng, {
                                    icon: markerIcons[markerType]
                                });
                                if (markerType === 'rocket') {
                                    marker.bindPopup('–ó–∞–≥—Ä–æ–∑–∞ –û—Ä—ñ—â–∞–Ω–∫–∏');
                                } else if (markerType === 'airfield') {
                                    marker.bindPopup('–ê—ç—Ä–æ–¥—Ä–æ–º');
                                } else if (markerType === 'base') {
                                    marker.bindPopup('–í–æ–µ–Ω–Ω–∞—è –±–∞–∑–∞');
                                }
                                return marker;
                            }
                        },
                        onEachFeature: function(feature, layer) {
                            layer.feature = layer.feature || { type: 'Feature', properties: {} };
                            layer.feature.properties = {
                                color: feature.properties.color || currentColor,
                                fillColor: feature.properties.fillColor || currentColor,
                                fillOpacity: feature.properties.fillOpacity !== undefined ? feature.properties.fillOpacity : currentOpacity,
                                weight: feature.properties.weight || 3,
                                markerType: feature.properties.markerType || 'rocket'
                            };
                            if (layer instanceof L.Polygon) {
                                layer.setStyle({
                                    color: layer.feature.properties.color,
                                    fillColor: layer.feature.properties.fillColor,
                                    fillOpacity: layer.feature.properties.fillOpacity
                                });
                            } else if (layer instanceof L.Polyline) {
                                layer.setStyle({
                                    color: layer.feature.properties.color,
                                    weight: layer.feature.properties.weight
                                });
                            } else if (layer instanceof L.Marker) {
                                layer.setIcon(markerIcons[layer.feature.properties.markerType]);
                                if (layer.feature.properties.markerType === 'rocket') {
                                    layer.bindPopup('–ó–∞–≥—Ä–æ–∑–∞ –û—Ä—ñ—â–∞–Ω–∫–∏');
                                } else if (layer.feature.properties.markerType === 'airfield') {
                                    layer.bindPopup('–ê—ç—Ä–æ–¥—Ä–æ–º');
                                } else if (layer.feature.properties.markerType === 'base') {
                                    layer.bindPopup('–í–æ–µ–Ω–Ω–∞—è –±–∞–∑–∞');
                                }
                            }
                            drawnItems.addLayer(layer);
                        }
                    });
                    updateMarkerVisibility();
                }
            }

            var selectedLayer = null;

            if (isAdmin()) {
                map.on(L.Draw.Event.CREATED, function (event) {
                    var layer = event.layer;
                    layer.feature = layer.feature || { type: 'Feature', properties: {} };
                    if (layer instanceof L.Polygon) {
                        layer.setStyle({
                            color: currentColor,
                            fillColor: currentColor,
                            fillOpacity: currentOpacity
                        });
                        layer.feature.properties = {
                            color: currentColor,
                            fillColor: currentColor,
                            fillOpacity: currentOpacity,
                            weight: 3
                        };
                    } else if (layer instanceof L.Polyline) {
                        layer.setStyle({
                            color: currentColor,
                            weight: 3
                        });
                        layer.feature.properties = {
                            color: currentColor,
                            weight: 3
                        };
                    } else if (layer instanceof L.Marker) {
                        layer.feature.properties = {
                            markerType: currentMarkerType
                        };
                        if (currentMarkerType === 'rocket') {
                            layer.bindPopup('–ó–∞–≥—Ä–æ–∑–∞ –û—Ä—ñ—â–∞–Ω–∫–∏');
                        } else if (currentMarkerType === 'airfield') {
                            layer.bindPopup('–ê—ç—Ä–æ–¥—Ä–æ–º');
                        } else if (currentMarkerType === 'base') {
                            layer.bindPopup('–í–æ–µ–Ω–Ω–∞—è –±–∞–∑–∞');
                        }
                        layer.setIcon(markerIcons[currentMarkerType]);
                    }
                    drawnItems.addLayer(layer);
                    updateMarkerVisibility();
                    saveLayers();
                });

                map.on(L.Draw.Event.DELETED, function () {
                    saveLayers();
                });

                function createSettingsPopup(layer) {
                    var popupContent = document.createElement('div');
                    popupContent.className = 'settings-popup';

                    var colorLabel = document.createElement('label');
                    colorLabel.textContent = 'Color';
                    var colorInput = document.createElement('input');
                    colorInput.type = 'color';
                    colorInput.value = layer.options.fillColor || currentColor;

                    var opacityLabel = document.createElement('label');
                    opacityLabel.textContent = 'Opacity';
                    var opacityInput = document.createElement('input');
                    opacityInput.type = 'range';
                    opacityInput.min = '0';
                    opacityInput.max = '1';
                    opacityInput.step = '0.1';
                    opacityInput.value = layer.options.fillOpacity || currentOpacity;

                    var applyButton = document.createElement('button');
                    applyButton.textContent = 'Apply';
                    applyButton.addEventListener('click', function() {
                        layer.setStyle({
                            color: colorInput.value,
                            fillColor: colorInput.value,
                            fillOpacity: parseFloat(opacityInput.value)
                        });
                        layer.feature.properties = {
                            color: colorInput.value,
                            fillColor: colorInput.value,
                            fillOpacity: parseFloat(opacityInput.value),
                            weight: 3
                        };
                        saveLayers();
                        map.closePopup();
                    });

                    popupContent.appendChild(colorLabel);
                    popupContent.appendChild(colorInput);
                    popupContent.appendChild(opacityLabel);
                    popupContent.appendChild(opacityInput);
                    popupContent.appendChild(applyButton);

                    var latlng = layer.getBounds().getCenter();
                    layer.bindPopup(popupContent, { className: 'settings-popup' }).openPopup(latlng);
                }

                drawnItems.on('click', function (e) {
                    if (selectedLayer) {
                        if (selectedLayer instanceof L.Polygon || selectedLayer instanceof L.Polyline) {
                            selectedLayer.setStyle({ weight: 3 });
                        }
                    }
                    selectedLayer = e.layer;
                    if (selectedLayer instanceof L.Polygon) {
                        selectedLayer.setStyle({ weight: 5 });
                        createSettingsPopup(selectedLayer);
                    } else if (selectedLayer instanceof L.Polyline) {
                        selectedLayer.setStyle({ weight: 5 });
                        var layerColor = selectedLayer.options.color || selectedLayer.options.fillColor;
                        currentColor = layerColor;
                        var colorInput = document.querySelector('.color-picker input[type="color"]');
                        if (colorInput) {
                            colorInput.value = layerColor;
                            colorInput.parentNode.style.backgroundColor = layerColor;
                        }
                        drawControl.setDrawingOptions({
                            polyline: {
                                shapeOptions: {
                                    color: currentColor,
                                    weight: 3
                                }
                            },
                            polygon: {
                                shapeOptions: {
                                    color: currentColor,
                                    fillColor: currentColor,
                                    fillOpacity: currentOpacity
                                }
                            }
                        });
                    }
                });

                map.on('click', function () {
                    if (selectedLayer && (selectedLayer instanceof L.Polygon || selectedLayer instanceof L.Polyline)) {
                        selectedLayer.setStyle({ weight: 3 });
                        selectedLayer = null;
                    }
                });

                map.on(L.Draw.Event.EDITED, function (event) {
                    var layers = event.layers;
                    layers.eachLayer(function(layer) {
                        if (layer instanceof L.Polygon) {
                            layer.setStyle({
                                color: currentColor,
                                fillColor: currentColor,
                                fillOpacity: currentOpacity
                            });
                            layer.feature.properties = {
                                color: currentColor,
                                fillColor: currentColor,
                                fillOpacity: currentOpacity,
                                weight: 3
                            };
                        } else if (layer instanceof L.Polyline) {
                            layer.setStyle({
                                color: currentColor,
                                weight: 3
                            });
                            layer.feature.properties = {
                                color: currentColor,
                                weight: 3
                            };
                        }
                        saveLayers();
                    });
                });
            }

            loadLayers();
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('currentUser') && localStorage.getItem('userRole')) {
                const adminStatus = JSON.parse(sessionStorage.getItem('adminStatus'));
                if (localStorage.getItem('userRole') === 'admin' && adminStatus.isTaken && adminStatus.adminUsername !== localStorage.getItem('currentUser')) {
                    alert('–†–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –±—ã–ª–∞ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.');
                    localStorage.setItem('userRole', 'user');
                }
                initMap();
            } else {
                loginModal.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>